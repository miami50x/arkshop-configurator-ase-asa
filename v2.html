<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARK Shop Config Editor</title>
  <style>
    /* Base Styles */
    body {
      background: linear-gradient(135deg, #a0beff, #f0f8ff);
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    /* Tab Navigation */
    header nav ul.tabs {
      list-style: none;
      display: flex;
      justify-content: center;
      padding: 0;
      margin-bottom: 1.5rem;
    }
    header nav ul.tabs li {
      padding: 0.75rem 1.5rem;
      margin: 0 0.5rem;
      background: #007bff;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }
    header nav ul.tabs li:hover {
      background: #0056b3;
      transform: translateY(-2px);
    }
    header nav ul.tabs li.active {
      background: #0056b3;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    /* Section Container */
    .tab-content {
      background: #ffffff;
      border: 1px solid #ddd;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .tab-content:hover {
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    .hidden {
      display: none;
    }
    /* Form Elements */
    .form-group {
      margin-bottom: 1rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #444;
    }
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="password"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #ccc;
      box-sizing: border-box;
      border-radius: 4px;
      transition: border-color 0.3s ease;
    }
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      border-color: #007bff;
      outline: none;
    }
    /* Buttons */
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 0.25rem;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .btn:hover {
      transform: scale(1.02);
    }
    .btn-primary {
      background: #007bff;
      color: white;
    }
    .btn-primary:hover {
      background: #0056b3;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-success:hover {
      background: #218838;
    }
    /* Dynamic List Items */
    .group-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.5rem;
      padding: 0.75rem;
      background: #f1f3f5;
      border-radius: 4px;
      border-left: 4px solid #007bff;
      transition: background-color 0.3s ease;
    }
    .group-item:hover {
      background: #e9ecef;
    }
    .remove-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .remove-btn:hover {
      background: #c82333;
    }
    .add-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 1rem;
      transition: background-color 0.3s ease;
    }
    .add-btn:hover {
      background: #218838;
    }
    /* Preformatted Output Block */
    .output {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid #e9ecef;
      max-height: 800px;
      overflow-y: auto;
    }
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    /* Collapsible Header */
    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f7f7f7;
      padding: 0.75rem 1rem;
      margin: 1rem 0;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .collapsible-header:hover {
      background: #e2e6ea;
    }
    .collapsible-content {
      margin-left: 1.5rem;
      margin-top: 0.5rem;
      border-left: 3px solid #ddd;
      padding-left: 1rem;
    }

    /* Blueprint Input Styles */
    .blueprint-input-wrapper {
      position: relative;
      display: block; /* ensures it can take full width if parent allows */
      width: 100%;
    }
    .blueprint-input {
      width: 100%; /* let the input stretch */
    }
    .suggestions li.highlighted {
      background: #007bff;
      color: white;
    }

    /* Suggestions Dropdown Styles */
    .suggestions {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .suggestions-item {
      display: flex;
      align-items: center;
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background-color 0.3s;
    }
    .suggestions-item:hover {
      background-color: #f0f8ff;
    }
    .item-image {
      width: 48px;
      height: 48px;
      object-fit: contain;
      margin-right: 10px;
    }
    .item-info {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }
    .item-title {
      font-weight: bold;
      font-size: 0.95rem;
      margin-bottom: 3px;
    }
    .item-path {
      font-size: 0.8rem;
      color: #666;
    }
    .item-compatibility {
      margin-top: 4px;
      font-size: 0.8rem;
      display: flex;
      gap: 16px;
    }
    .highlighted {
      background-color: #007bff;
      color: #fff;
    }
    .highlighted .item-title {
      color: #fff;
    }
    .highlighted .item-path {
      color: #eee;
    }
    /* Checkmarks and X Icons */
    .green-check::before {
      content: "✓";
      color: green;
      font-weight: bold;
    }
    .red-x::before {
      content: "✗";
      color: red;
      font-weight: bold;
    }
    .item-key {
      font-size: 0.85rem;
      font-weight: bold;
      margin-bottom: 2px;
    }

    /* Thumbnail & Quantity Badge */
    .thumbnail-container {
      display: inline-block;
      position: relative;
      width: 48px;
      height: 48px;
      margin-bottom: 0.5rem;
      vertical-align: middle;
    }
    .thumbnail-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fafafa;
    }
    .quantity-badge {
      position: absolute;
      bottom: -5px;
      right: -5px;
      background: #dc3545;
      color: white;
      padding: 2px 6px;
      border-radius: 50%;
      font-size: 0.8rem;
      line-height: 1;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* NEW: Thumbnails in the header */
    .header-info {
      display: flex;
      flex-direction: column;
    }
    .header-info h3 {
      margin: 0 0 0.25rem 0;
    }
    .header-thumbnails {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    /* Permission Selector Checkbox Styles */
    .permission-selector-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    .permission-selector-container .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .permission-selector-container label {
      font-weight: normal; /* Overwrite the global label style if desired */
    }
  </style>
  
  <!-- Include Vue -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  
  <!-- GLOBAL BLUEPRINT FETCH -->
  <script>
    window.blueprintStore = new Vue({
      data: {
        blueprintOptions: {},
        blueprintPaths: {},
        // NEW: Add filters for ASE/ASA
        blueprintFilters: {
          includeASE: true,
          includeASA: true
        }
      }
    });

    fetch('https://miami50x.github.io/arkshop-configurator-ase-asa/ark_ase_asa_blueprints.json')
      .then(response => response.json())
      .then(data => {
        const options = data.reduce((acc, itemObj) => {
          const [uniqueKey] = Object.keys(itemObj);
          const value = itemObj[uniqueKey];

          acc[uniqueKey] = {
            path: value.blueprint_path || "",
            tags: [],
            title: value.title || uniqueKey,
            image: "https://miami50x.github.io/arkshop-configurator-ase-asa/" + (value.image || "ark_assets_img/placeholder.webp"),
            ase: value.ase || false,
            asa: value.asa || false,
            class_string: ""
          };
          return acc;
        }, {});

        // Create a reverse lookup for blueprint paths
        const paths = {};
        Object.keys(options).forEach(key => {
          const path = options[key].path.toLowerCase();
          if (path) {
            paths[path] = options[key];
          }
        });

        window.blueprintStore.blueprintOptions = options;
        window.blueprintStore.blueprintPaths = paths;
      })
      .catch(error => console.error('Error fetching blueprint data:', error));
  </script>
  
  <!-- Global function for blueprint thumbnail lookup -->
  <script>
    function getBlueprintImage(blueprintPath) {
      if (!blueprintPath) {
        return "https://miami50x.github.io/arkshop-configurator-ase-asa/ark_assets_img/placeholder.webp";
      }
      const lookupKey = blueprintPath.toLowerCase();
      if (window.blueprintStore.blueprintPaths && window.blueprintStore.blueprintPaths[lookupKey]) {
        return window.blueprintStore.blueprintPaths[lookupKey].image;
      }
      return "https://miami50x.github.io/arkshop-configurator-ase-asa/ark_assets_img/placeholder.webp";
    }
  </script>

  <!-- Global Blueprint Input Component -->
  <script>
    Vue.component('blueprint-input', {
      template: `
        <div class="blueprint-input-wrapper">
          <input
            type="text"
            :value="value"
            @input="onInput"
            @focus="onFocus"
            @keydown.down.prevent="highlightNext"
            @keydown.up.prevent="highlightPrev"
            @keydown.enter.prevent="selectHighlighted"
            placeholder="Enter blueprint..."
            class="blueprint-input"
          />
          <ul 
            v-if="showDropdown && filteredBlueprints.length" 
            class="suggestions"
          >
            <li 
              v-for="([uniqueKey, bp], index) in filteredBlueprints" 
              :key="uniqueKey"
              :class="['suggestions-item', { 'highlighted': index === highlightedIndex }]"
              @mousedown.prevent="selectBlueprint(bp)"
            >
              <img :src="bp.image" class="item-image" />
              <div class="item-info">
                <div class="item-key">{{ formatKey(uniqueKey) }}</div>
                <div class="item-path">{{ bp.path }}</div>
                <div class="item-compatibility">
                  <span>
                    ASE: <span :class="bp.ase ? 'green-check' : 'red-x'"></span>
                  </span>
                  <span>
                    ASA: <span :class="bp.asa ? 'green-check' : 'red-x'"></span>
                  </span>
                </div>
              </div>
            </li>
          </ul>
        </div>
      `,
      props: {
        value: {
          type: String,
          default: ''
        },
        blueprintOptions: {
          type: Object,
          default: () => ({})
        }
      },
      data() {
        return {
          showDropdown: false,
          highlightedIndex: -1
        };
      },
      computed: {
        actualBlueprintOptions() {
          const localKeys = Object.keys(this.blueprintOptions);
          if (localKeys.length > 0) {
            return this.blueprintOptions;
          }
          return window.blueprintStore.blueprintOptions || {};
        },
        filteredBlueprints() {
          const query = this.value.trim().toLowerCase();
          const entries = Object.entries(this.actualBlueprintOptions);

          // Filter by key, title, or blueprint path
          let filtered = entries.filter(([key, bp]) => {
            const path = bp.path ? bp.path.toLowerCase() : "";
            return (
              key.toLowerCase().includes(query) ||
              (bp.title && bp.title.toLowerCase().includes(query)) ||
              (path && path.includes(query))
            );
          });

          // Then apply the ASA/ASE filters
          filtered = filtered.filter(([_, bp]) => {
            const matchesASE = bp.ase && window.blueprintStore.blueprintFilters.includeASE;
            const matchesASA = bp.asa && window.blueprintStore.blueprintFilters.includeASA;
            return (matchesASE || matchesASA);
          });

          if (filtered.length > 20) {
            filtered = filtered.slice(0, 20);
          }
          return filtered;
        }
      },
      methods: {
        onInput(e) {
          this.$emit('input', e.target.value);
          this.highlightedIndex = -1;
          this.showDropdown = (e.target.value.trim().length >= 3);
        },
        onFocus() {
          // Show dropdown only if at least 3 characters
          this.showDropdown = (this.value.trim().length >= 3);
        },
        selectBlueprint(bp) {
          this.$emit('input', bp.path);
          this.showDropdown = false;
        },
        highlightNext() {
          if (this.highlightedIndex < this.filteredBlueprints.length - 1) {
            this.highlightedIndex++;
          }
        },
        highlightPrev() {
          if (this.highlightedIndex > 0) {
            this.highlightedIndex--;
          }
        },
        selectHighlighted() {
          if (
            this.highlightedIndex >= 0 &&
            this.highlightedIndex < this.filteredBlueprints.length
          ) {
            const bp = this.filteredBlueprints[this.highlightedIndex][1];
            this.selectBlueprint(bp);
          }
        },
        handleClickOutside(event) {
          if (!this.$el.contains(event.target)) {
            this.showDropdown = false;
          }
        },
        formatKey(keyStr) {
          return keyStr
            .split('-')
            .map(part => part.charAt(0).toUpperCase() + part.slice(1))
            .join(' ');
        }
      },
      mounted() {
        document.addEventListener('click', this.handleClickOutside);
      },
      beforeDestroy() {
        document.removeEventListener('click', this.handleClickOutside);
      }
    });
  </script>

  <!-- NEW: Permission Selector Component -->
  <script>
    /*
      permission-selector
      - Renders known group names as checkboxes (from generalVue.config.TimedPointsReward.Groups).
      - Also allows custom entries that are not in the known list.
      - The final selected groups are stored as a comma-separated string (for backward compatibility).
    */
    Vue.component('permission-selector', {
      template: `
      <div>
        <label>Permissions:</label>
        <!-- The official checkboxes for known groups -->
        <div class="permission-selector-container">
          <div
            v-for="knownGroup in knownGroups"
            :key="knownGroup"
            class="checkbox-group"
          >
            <input
              type="checkbox"
              :id="knownGroup"
              :value="knownGroup"
              v-model="selectedGroups"
            />
            <label :for="knownGroup">{{ knownGroup }}</label>
          </div>
        </div>
        
        <!-- Custom Input for entering other permission tags not in knownGroups -->
        <div class="form-group" style="margin-top:1rem;">
          <label>Add Custom Permission Group</label>
          <input
            type="text"
            v-model="customPermission"
            placeholder="Type custom group, then press Enter"
            @keyup.enter.prevent="addCustomPermission"
          />
        </div>

        <!-- Hidden or alternative display to show currently selected permissions -->
        <p style="margin-top:0.5rem;">
          <strong>Selected:</strong> {{ selectedGroups.join(', ') }}
        </p>
      </div>
      `,
      props: {
        value: {
          type: String,
          default: ''
        }
      },
      data() {
        return {
          selectedGroups: [],
          customPermission: ''
        };
      },
      computed: {
        knownGroups() {
          // Grabs group names from the TimedPointsReward.Groups in the general config
          const groupsObj = window.generalVue.config.TimedPointsReward.Groups || {};
          return Object.keys(groupsObj);
        }
      },
      watch: {
        // If parent changes 'value' externally, we parse it again
        value: {
          immediate: true,
          handler(newVal) {
            const arr = newVal.split(',').map(p => p.trim()).filter(Boolean);
            this.selectedGroups = arr;
          }
        },
        // Whenever selectedGroups changes, emit up as a comma-separated string
        selectedGroups(newVal) {
          this.$emit('input', newVal.join(', '));
        }
      },
      methods: {
        addCustomPermission() {
          const trimmed = this.customPermission.trim();
          if (trimmed && !this.selectedGroups.includes(trimmed)) {
            this.selectedGroups.push(trimmed);
          }
          this.customPermission = '';
        }
      }
    });
  </script>

</head>
<body>
  <header>
    <h1>ARK Shop Config Editor</h1>
    <nav>
      <ul class="tabs">
        <li data-tab="general" class="active">General</li>
        <li data-tab="kits">Kits</li>
        <li data-tab="shopitems">Shop Items</li>
        <li data-tab="sellitems">Sell Items</li>
        <li data-tab="messages">Messages</li>
      </ul>
    </nav>
  </header>

  <main>
    <!-- General Config Section -->
    <section id="general" class="tab-content">
      <div id="general-config-inner">
        <!-- Collapsible Panels -->
        <div>
          <!-- MySQL Settings -->
          <div class="collapsible-header" @click="toggleSection('mysql')">
            <h3>MySQL Settings</h3>
          </div>
          <div v-if="expandedSections.mysql" class="collapsible-content">
            <div class="form-group">
              <label>
                <input type="checkbox" v-model="config.Mysql.UseMysql">
                Use MySQL
              </label>
            </div>
            <div class="subsection" v-if="config.Mysql.UseMysql">
              <div class="form-group">
                <label>MySQL Host</label>
                <input type="text" v-model="config.Mysql.MysqlHost">
              </div>
              <div class="form-group">
                <label>MySQL User</label>
                <input type="text" v-model="config.Mysql.MysqlUser">
              </div>
              <div class="form-group">
                <label>MySQL Password</label>
                <input type="password" v-model="config.Mysql.MysqlPass">
              </div>
              <div class="form-group">
                <label>MySQL Database</label>
                <input type="text" v-model="config.Mysql.MysqlDB">
              </div>
              <div class="form-group">
                <label>MySQL Port</label>
                <input type="number" v-model.number="config.Mysql.MysqlPort">
              </div>
            </div>
          </div>

          <!-- Timed Points Reward / Permission Groups -->
          <div class="collapsible-header" @click="toggleSection('timedPoints')">
            <h3>Points Reward & Permission Groups</h3>
          </div>
          <div v-if="expandedSections.timedPoints" class="collapsible-content">
            <div class="form-group">
              <label>
                <input type="checkbox" v-model="config.TimedPointsReward.Enabled">
                Enable Timed Points Reward
              </label>
            </div>
            <div class="subsection" v-if="config.TimedPointsReward.Enabled">
              <div class="form-group">
                <label>
                  <input type="checkbox" v-model="config.TimedPointsReward.StackRewards">
                  Stack Rewards (sum of all group rewards)
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" v-model="config.TimedPointsReward.AlwaysSendNotifications">
                  Always Send Notifications (even for 0 points)
                </label>
              </div>
              <div class="form-group">
                <label>Interval (minutes)</label>
                <input type="number" v-model.number="config.TimedPointsReward.Interval" min="1">
              </div>

              <!-- Permission Groups Definition -->
              <h4>Define Permission Groups & Point Amount</h4>
              <div class="group-list">
                <div v-for="(group, name) in groups" :key="name" class="group-item">
                  <input
                    type="text"
                    :value="name"
                    @blur="updateGroupName(name, $event.target.value)"
                    placeholder="Group Name"
                  >
                  <input
                    type="number"
                    v-model.number="group.Amount"
                    placeholder="Points Amount"
                    min="0"
                  >
                  <button class="remove-btn" @click="removeGroup(name)">Remove</button>
                </div>
                <button class="add-btn" @click="addGroup">Add Permission Group</button>
              </div>
            </div>
          </div>

          <!-- Discord Settings -->
          <div class="collapsible-header" @click="toggleSection('discord')">
            <h3>Discord Settings</h3>
          </div>
          <div v-if="expandedSections.discord" class="collapsible-content">
            <div class="form-group">
              <label>
                <input type="checkbox" v-model="config.Discord.Enabled">
                Enable Discord Logging
              </label>
            </div>
            <div class="subsection" v-if="config.Discord.Enabled">
              <div class="form-group">
                <label>Sender Name</label>
                <input type="text" v-model="config.Discord.SenderName">
              </div>
              <div class="form-group">
                <label>Webhook URL</label>
                <input type="text" v-model="config.Discord.URL">
              </div>
            </div>
          </div>

          <!-- Basic Settings -->
          <div class="collapsible-header" @click="toggleSection('basic')">
            <h3>Basic Settings</h3>
          </div>
          <div v-if="expandedSections.basic" class="collapsible-content">
            <div class="form-group">
              <label>Items Per Page</label>
              <input type="number" v-model.number="config.ItemsPerPage" min="1">
            </div>
            <div class="form-group">
              <label>Shop Display Time (seconds)</label>
              <input type="number" v-model.number="config.ShopDisplayTime" step="0.1" min="0">
            </div>
            <div class="form-group">
              <label>Shop Text Size</label>
              <input type="number" v-model.number="config.ShopTextSize" step="0.1" min="0">
            </div>
            <div class="form-group">
              <label>Database Path Override</label>
              <input type="text" v-model="config.DbPathOverride">
            </div>
            <div class="form-group">
              <label>Default Kit</label>
              <input type="text" v-model="config.DefaultKit">
            </div>
          </div>

          <!-- Dino Settings -->
          <div class="collapsible-header" @click="toggleSection('dino')">
            <h3>Dino Settings</h3>
          </div>
          <div v-if="expandedSections.dino" class="collapsible-content">
            <div class="form-group">
              <label>
                <input type="checkbox" v-model="config.GiveDinosInCryopods">
                Give Dinos in Cryopods
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" v-model="config.UseSoulTraps">
                Use Soul Traps (Dino Storage V2)
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" v-model="config.CryoLimitedTime">
                Cryo Limited Time (60 min)
              </label>
            </div>
            <div class="form-group">
              <label>Cryo Item Path</label>
              <input type="text" v-model="config.CryoItemPath">
            </div>
          </div>

          <!-- Trade & Usage Settings -->
          <div class="collapsible-header" @click="toggleSection('tradeUsage')">
            <h3>Trade & Usage Settings</h3>
          </div>
          <div v-if="expandedSections.tradeUsage" class="collapsible-content">
            <div class="form-group">
              <label>
                <input type="checkbox" v-model="config.UseOriginalTradeCommandWithUI">
                Use Original Trade Command With UI
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" v-model="config.PreventUseNoglin">
                Prevent Use While Controlled by Noglin
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" v-model="config.PreventUseUnconscious">
                Prevent Use While Unconscious
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" v-model="config.PreventUseHandcuffed">
                Prevent Use While Handcuffed
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" v-model="config.PreventUseCarried">
                Prevent Use While Carried
              </label>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Kits Config Section -->
    <section id="kits" class="tab-content hidden">
      <div id="kit-config-inner">
        <div class="section">
          <div style="margin-bottom: 1rem;">
            <button class="btn btn-primary" @click="addKit">Add New Kit</button>
            <button class="btn btn-primary" @click="expandAllKits">Expand All</button>
            <button class="btn btn-primary" @click="collapseAllKits">Collapse All</button>
          </div>
          <div v-for="(kit, kitId) in config.Kits" :key="kitId" class="kit-card">
            <div class="collapsible-header" @click="toggleKit(kitId)">
              <div class="header-info">
                <h3>{{ kitId }}</h3>
                <div class="header-thumbnails" v-if="kit.Items && kit.Items.length">
                  <div 
                    v-for="(item, idx) in kit.Items" 
                    :key="'item-' + idx" 
                    class="thumbnail-container"
                  >
                    <img :src="getBlueprintImage(item.Blueprint)" :alt="item.Blueprint" />
                    <div class="quantity-badge" v-if="item.Amount > 1">x{{ item.Amount }}</div>
                  </div>
                </div>
                <div class="header-thumbnails" v-if="kit.Dinos && kit.Dinos.length">
                  <div 
                    v-for="(dino, idx) in kit.Dinos" 
                    :key="'dino-' + idx" 
                    class="thumbnail-container"
                  >
                    <img :src="getBlueprintImage(dino.Blueprint)" :alt="dino.Blueprint" />
                  </div>
                </div>
              </div>
              <button class="btn btn-danger" @click.stop="removeKit(kitId)">Remove Kit</button>
            </div>

            <div v-if="expandedKits[kitId]" class="kit-content">
              <div class="form-group">
                <label>Kit ID</label>
                <input type="text" :value="kitId" @blur="updateKitKey(kitId, $event.target.value)" placeholder="Kit ID">
              </div>
              <div class="form-group">
                <label>Default Amount</label>
                <input type="number" v-model.number="kit.DefaultAmount" min="0">
              </div>
              <div class="form-group">
                <label>Price</label>
                <input type="number" v-model.number="kit.Price" min="0">
              </div>
              <div class="form-group">
                <label>Description</label>
                <textarea v-model="kit.Description" rows="2"></textarea>
              </div>

              <!-- Use the new permission-selector -->
              <permission-selector v-model="kit.Permissions"></permission-selector>

              <div class="form-group">
                <label>
                  <input type="checkbox" v-model="kit.OnlyFromSpawn">
                  Only From Spawn
                </label>
              </div>

              <!-- Items Section -->
              <div class="subsection">
                <h4>Items</h4>
                <button class="btn btn-success" @click="addItem(kit)">Add Item</button>
                <div 
                  v-for="(item, index) in kit.Items" 
                  :key="index" 
                  style="margin-top:1rem; border:1px solid #ccc; padding:1rem; border-radius:6px;"
                >
                  <div class="form-group">
                    <label>Blueprint</label>
                    <div style="display:flex; align-items:center;">
                      <img 
                        :src="getBlueprintImage(item.Blueprint)"
                        style="width:40px; height:40px; margin-right:8px;" 
                      />
                      <blueprint-input style="flex:1;" v-model="item.Blueprint"></blueprint-input>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Amount</label>
                    <input type="number" v-model.number="item.Amount" min="1">
                  </div>
                  <div class="form-group">
                    <label>Quality</label>
                    <input type="number" v-model.number="item.Quality" min="0">
                  </div>
                  <div class="form-group">
                    <label>
                      <input type="checkbox" v-model="item.ForceBlueprint">
                      Force Blueprint
                    </label>
                  </div>
                  <button class="btn btn-danger" style="margin-top: 0.5rem;" @click="removeItem(kit, index)">Remove Item</button>
                </div>
              </div>

              <!-- Dinos Section -->
              <div class="subsection">
                <h4>Dinos</h4>
                <button class="btn btn-success" @click="addDino(kit)">Add Dino</button>
                <div 
                  v-for="(dino, index) in kit.Dinos" 
                  :key="index"
                  style="margin-top:1rem; border:1px solid #ccc; padding:1rem; border-radius:6px;"
                >
                  <div class="form-group">
                    <label>Level</label>
                    <input type="number" v-model.number="dino.Level" min="1">
                  </div>
                  <div class="form-group">
                    <label>Blueprint</label>
                    <div style="display:flex; align-items:center;">
                      <img 
                        :src="getBlueprintImage(dino.Blueprint)"
                        style="width:40px; height:40px; margin-right:8px;" 
                      />
                      <blueprint-input style="flex:1;" v-model="dino.Blueprint"></blueprint-input>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>
                      <input type="checkbox" v-model="dino.Neutered">
                      Neutered
                    </label>
                  </div>
                  <button class="btn btn-danger" style="margin-top: 0.5rem;" @click="removeDino(kit, index)">Remove Dino</button>
                </div>
              </div>

              <!-- Commands Section -->
              <div class="subsection">
                <h4>Commands</h4>
                <button class="btn btn-success" @click="addCommand(kit)">Add Command</button>
                <div 
                  v-for="(command, index) in kit.Commands" 
                  :key="index" 
                  style="margin-top:1rem; border:1px solid #ccc; padding:1rem; border-radius:6px;"
                >
                  <div class="form-group">
                    <label>Command</label>
                    <input type="text" v-model="command.Command">
                  </div>
                  <div class="form-group">
                    <label>Display As</label>
                    <input type="text" v-model="command.DisplayAs">
                  </div>
                  <button class="btn btn-danger" @click="removeCommand(kit, index)">Remove Command</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Shop Items Config Section -->
    <section id="shopitems" class="tab-content hidden">
      <div id="shopitems-config-inner">
        <div class="section">
          <div style="margin-bottom: 1rem;">
            <button class="btn btn-primary" @click="addItem">Add New Shop Item</button>
            <button class="btn btn-primary" @click="expandAllItems">Expand All</button>
            <button class="btn btn-primary" @click="collapseAllItems">Collapse All</button>
          </div>
          <div v-for="(item, name) in config.ShopItems" :key="name" class="item-card">
            <div class="collapsible-header" @click="toggleItem(name)">
              <div class="header-info">
                <h3>{{ name }} ({{ item.Type }})</h3>
                <div class="header-thumbnails" v-if="item.Type === 'dino' && item.Blueprint">
                  <div class="thumbnail-container">
                    <img :src="getBlueprintImage(item.Blueprint)" :alt="item.Blueprint" />
                  </div>
                </div>
                <div class="header-thumbnails" v-if="item.Type === 'item' && item.Items && item.Items.length">
                  <div 
                    v-for="(sub, idx) in item.Items" 
                    :key="idx" 
                    class="thumbnail-container"
                  >
                    <img :src="getBlueprintImage(sub.Blueprint)" :alt="sub.Blueprint" />
                    <div class="quantity-badge" v-if="sub.Amount > 1">x{{ sub.Amount }}</div>
                  </div>
                </div>
              </div>
              <button class="btn btn-danger" @click.stop="removeShopItem(name)">Remove Item</button>
            </div>
            <div v-if="expandedItems[name]" class="item-content">
              <div class="form-group">
                <label>Item Name</label>
                <input type="text" :value="name" @blur="updateShopItemName(name, $event.target.value)">
              </div>
              <div class="form-group">
                <label>Type</label>
                <select v-model="item.Type" class="type-select" @change="handleTypeChange(name, item.Type)">
                  <option value="dino">Dino</option>
                  <option value="item">Item</option>
                  <option value="beacon">Beacon</option>
                  <option value="experience">Experience</option>
                  <option value="unlockengram">Unlock Engram</option>
                  <option value="command">Command</option>
                </select>
              </div>

              <permission-selector v-model="item.Permissions"></permission-selector>

              <div class="form-group">
                <label>Description</label>
                <textarea v-model="item.Description" rows="2"></textarea>
              </div>
              <div class="form-group">
                <label>Price</label>
                <input 
                  type="number" 
                  v-model.number="item.Price" 
                  min="0"
                  @input="(event)=>{ if(parseFloat(event.target.value) < 0) { item.Price = 0; } }"
                >
              </div>

              <!-- Dino Settings -->
              <div v-if="item.Type === 'dino'" class="subsection">
                <h4>Dino Settings</h4>
                <div class="form-group">
                  <label>Level</label>
                  <input 
                    type="number" 
                    v-model.number="item.Level" 
                    min="1" 
                    max="1000"
                    @input="(event)=>{ 
                      let val = parseInt(event.target.value); 
                      if(val < 1){ item.Level = 1; } else if(val > 1000){ item.Level = 1000; } 
                    }"
                  >
                </div>
                <div class="form-group">
                  <label>Blueprint</label>
                  <div style="display:flex; align-items:center;">
                    <img 
                      :src="getBlueprintImage(item.Blueprint)" 
                      style="width:40px; height:40px; margin-right:8px;" 
                    />
                    <blueprint-input style="flex:1;" v-model="item.Blueprint"></blueprint-input>
                  </div>
                </div>
                <div v-if="item.Blueprint && item.Blueprint.toLowerCase().includes('tekstrider')" class="stryder-section">
                  <h5>Stryder Configuration</h5>
                  <div class="form-group">
                    <label>Stryder Head</label>
                    <select v-model="item.StryderHead" class="type-select">
                      <option v-for="(headName, value) in stryderHeadTypes" :key="value" :value="Number(value)">
                        {{ headName }}
                      </option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Stryder Chest</label>
                    <select v-model="item.StryderChest" class="type-select">
                      <option v-for="(chestName, value) in stryderChestTypes" :key="value" :value="Number(value)">
                        {{ chestName }}
                      </option>
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" v-model="item.PreventCryo">
                    Prevent Cryopod
                  </label>
                </div>
              </div>

              <!-- Multiple-Items Settings -->
              <div v-else-if="item.Type === 'item'" class="subsection">
                <h4>Item(s) Settings</h4>
                <button class="btn btn-success" @click="addSubItem(name)">Add Item</button>
                <div 
                  v-for="(subItem, idx) in item.Items" 
                  :key="idx"
                  style="margin-top:1rem; border:1px solid #ccc; padding:1rem; border-radius:6px;"
                >
                  <div class="form-group">
                    <label>Blueprint</label>
                    <div style="display:flex; align-items:center;">
                      <img 
                        :src="getBlueprintImage(subItem.Blueprint)" 
                        style="width:40px; height:40px; margin-right:8px;" 
                      />
                      <blueprint-input style="flex:1;" v-model="subItem.Blueprint"></blueprint-input>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Amount</label>
                    <input type="number" v-model.number="subItem.Amount" min="1">
                  </div>
                  <div class="form-group">
                    <label>Quality</label>
                    <input type="number" v-model.number="subItem.Quality" min="0">
                  </div>
                  <div class="form-group">
                    <label>
                      <input type="checkbox" v-model="subItem.ForceBlueprint">
                      Force Blueprint
                    </label>
                  </div>
                  <button class="btn btn-danger" @click="removeSubItem(name, idx)">Remove</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Sell Items Config Section -->
    <section id="sellitems" class="tab-content hidden">
      <div id="sellitems-config-inner">
        <div class="section">
          <div style="margin-bottom: 1rem;">
            <button class="btn btn-primary" @click="addSellItem">Add New Sell Item</button>
            <button class="btn btn-primary" @click="expandAllSellItems">Expand All</button>
            <button class="btn btn-primary" @click="collapseAllSellItems">Collapse All</button>
          </div>
          <div v-for="(sellItem, key) in config.SellItems" :key="key" class="item-card">
            <div class="collapsible-header" @click="toggleSellItem(key)">
              <div class="header-info">
                <h3>{{ key }} ({{ sellItem.Type }})</h3>
                <div class="header-thumbnails" v-if="sellItem.Blueprint">
                  <div class="thumbnail-container">
                    <img :src="getBlueprintImage(sellItem.Blueprint)" :alt="sellItem.Blueprint" />
                    <div class="quantity-badge" v-if="sellItem.Amount > 1">x{{ sellItem.Amount }}</div>
                  </div>
                </div>
              </div>
              <button class="btn btn-danger" @click.stop="removeSellItem(key)">Remove</button>
            </div>
            <div v-if="expandedSellItems[key]" class="item-content">
              <div class="form-group">
                <label>Sell Item ID</label>
                <input type="text" :value="key" @blur="updateSellItemKey(key, $event.target.value)">
              </div>
              <div class="form-group">
                <label>Type</label>
                <input type="text" v-model="sellItem.Type">
              </div>
              <div class="form-group">
                <label>Description</label>
                <textarea v-model="sellItem.Description" rows="2"></textarea>
              </div>
              <div class="form-group">
                <label>Price</label>
                <input type="number" v-model.number="sellItem.Price" min="0">
              </div>
              <div class="form-group">
                <label>Amount</label>
                <input type="number" v-model.number="sellItem.Amount" min="1">
              </div>
              <div class="form-group">
                <label>Blueprint</label>
                <div style="display:flex; align-items:center;">
                  <img 
                    :src="getBlueprintImage(sellItem.Blueprint)" 
                    style="width:40px; height:40px; margin-right:8px;" 
                  />
                  <blueprint-input style="flex:1;" v-model="sellItem.Blueprint"></blueprint-input>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Messages Config Section -->
    <section id="messages" class="tab-content hidden">
      <div id="messages-config-inner">
        <div class="section">
          <h3>Messages</h3>
          <div class="group-list">
            <div v-for="(value, key) in messages" :key="key" class="group-item">
              <input type="text" :value="key" @blur="updateMessageKey(key, $event.target.value)" placeholder="Message Key">
              <textarea v-model="messages[key]" rows="2" placeholder="Message Value"></textarea>
              <button class="remove-btn" @click="removeMessage(key)">Remove</button>
            </div>
            <button class="add-btn" @click="addMessage">Add Message</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Complete Config and Load JSON Section -->
  <div id="configApp">
    <section id="complete-config">
      <h2>Complete JSON Configuration</h2>
      <button id="copy-btn" class="btn btn-primary" @click="copyJSON">Copy JSON</button>
      <div class="output">
        <pre>{{ jsonOutput }}</pre>
      </div>
    </section>
    <section id="load-config">
      <h2>Load JSON Configuration</h2>
      <textarea v-model="jsonInput" rows="10" style="width: 100%;" placeholder="Paste your JSON configuration here"></textarea>
      <button class="btn btn-primary" @click="loadJSON">Load JSON</button>
      <!-- NEW: Load Demo Button -->
      <button class="btn btn-primary" @click="loadDemoConfig">Load Demo Config</button>
    </section>

    <!-- NEW: Blueprint Filter Section + Links to commented JSON -->
    <section id="blueprint-filters">
      <h2>Blueprint Filters</h2>
      <div class="form-group">
        <label>
          <input type="checkbox" v-model="blueprintStore.blueprintFilters.includeASE">
          Include ASE
        </label>
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" v-model="blueprintStore.blueprintFilters.includeASA">
          Include ASA
        </label>
      </div>

      <!-- Links to commented configs -->
      <div style="margin-top: 1rem;">
        <p>Commented Config Examples:</p>
        <ul>
          <li>
            <a 
              href="https://miami50x.github.io/arkshop-configurator-ase-asa/ark_ase_commented.json" 
              target="_blank" rel="noopener noreferrer"
            >
              Commented ASE Config JSON
            </a>
          </li>
          <li>
            <a 
              href="https://miami50x.github.io/arkshop-configurator-ase-asa/ark_asa_commented.json" 
              target="_blank" rel="noopener noreferrer"
            >
              Commented ASA Config JSON
            </a>
          </li>
        </ul>
      </div>
    </section>
  </div>

  <!-- Tab Navigation Script -->
  <script>
    document.querySelectorAll("header nav ul.tabs li").forEach(tab => {
      tab.addEventListener("click", function () {
        document.querySelectorAll("header nav ul.tabs li").forEach(t => t.classList.remove("active"));
        this.classList.add("active");
        document.querySelectorAll("main section.tab-content").forEach(section => section.classList.add("hidden"));
        const tabId = this.getAttribute("data-tab");
        document.getElementById(tabId).classList.remove("hidden");
      });
    });
  </script>

  <!-- Vue Instances -->
  <script>
    // --- General Config Vue Instance ---
    window.generalVue = new Vue({
      el: '#general',
      data: {
        expandedSections: {
          mysql: true,
          timedPoints: true,
          discord: false,
          basic: false,
          dino: false,
          tradeUsage: false
        },
        // All defaults removed / set to blank or minimal
        config: {
          Mysql: {
            UseMysql: false,
            MysqlHost: "",
            MysqlUser: "",
            MysqlPass: "",
            MysqlDB: "",
            MysqlPort: 0
          },
          TimedPointsReward: {
            Enabled: false,
            StackRewards: false,
            AlwaysSendNotifications: false,
            Interval: 0,
            Groups: {}
          },
          Discord: {
            Enabled: false,
            SenderName: "",
            URL: ""
          },
          ItemsPerPage: 0,
          ShopDisplayTime: 0,
          ShopTextSize: 0,
          DbPathOverride: "",
          DefaultKit: "",
          GiveDinosInCryopods: false,
          UseSoulTraps: false,
          CryoLimitedTime: false,
          CryoItemPath: "",
          UseOriginalTradeCommandWithUI: false,
          PreventUseNoglin: false,
          PreventUseUnconscious: false,
          PreventUseHandcuffed: false,
          PreventUseCarried: false
        }
      },
      computed: {
        groups() {
          return this.config.TimedPointsReward.Groups;
        }
      },
      methods: {
        toggleSection(sectionName) {
          this.$set(this.expandedSections, sectionName, !this.expandedSections[sectionName]);
        },
        addGroup() {
          const groupName = `Group-${Object.keys(this.groups).length + 1}`;
          this.$set(this.groups, groupName, { Amount: 0 });
        },
        removeGroup(groupName) {
          this.$delete(this.groups, groupName);
        },
        updateGroupName(oldName, newName) {
          if (oldName === newName || !newName.trim()) return;
          if (this.groups.hasOwnProperty(newName)) {
            alert("Group name already exists");
            return;
          }
          const groupData = this.groups[oldName];
          this.$delete(this.groups, oldName);
          this.$set(this.groups, newName, groupData);
        }
      }
    });

    // --- Kit Config Vue Instance ---
    window.kitsVue = new Vue({
      el: '#kits',
      data: {
        expandedKits: {},
        // Empty kits by default
        config: {
          Kits: {}
        }
      },
      methods: {
        getBlueprintImage,
        toggleKit(kitKey) {
          this.$set(this.expandedKits, kitKey, !this.expandedKits[kitKey]);
        },
        addKit() {
          const newKitKey = `kit_${Object.keys(this.config.Kits).length + 1}`;
          this.$set(this.config.Kits, newKitKey, {
            DefaultAmount: 0,
            Price: 0,
            Description: '',
            OnlyFromSpawn: false,
            Permissions: '',
            Items: [],
            Dinos: [],
            Commands: []
          });
          this.$set(this.expandedKits, newKitKey, true);
        },
        removeKit(kitKey) {
          this.$delete(this.config.Kits, kitKey);
          this.$delete(this.expandedKits, kitKey);
        },
        updateKitKey(oldKey, newKey) {
          newKey = newKey.trim();
          if (oldKey === newKey || !newKey) return;
          if (this.config.Kits.hasOwnProperty(newKey)) {
            alert("Kit key already exists");
            return;
          }
          const kit = this.config.Kits[oldKey];
          this.$delete(this.config.Kits, oldKey);
          this.$set(this.config.Kits, newKey, kit);
          const wasExpanded = this.expandedKits[oldKey];
          this.$delete(this.expandedKits, oldKey);
          this.$set(this.expandedKits, newKey, wasExpanded);
        },
        addItem(kit) {
          if (!kit.Items) this.$set(kit, 'Items', []);
          kit.Items.push({
            Amount: 1,
            Quality: 0,
            ForceBlueprint: false,
            Blueprint: ''
          });
        },
        removeItem(kit, index) {
          kit.Items.splice(index, 1);
        },
        addDino(kit) {
          if (!kit.Dinos) this.$set(kit, 'Dinos', []);
          kit.Dinos.push({
            Level: 1,
            Blueprint: '',
            Neutered: false
          });
        },
        removeDino(kit, index) {
          kit.Dinos.splice(index, 1);
        },
        addCommand(kit) {
          if (!kit.Commands) this.$set(kit, 'Commands', []);
          kit.Commands.push({
            Command: '',
            DisplayAs: ''
          });
        },
        removeCommand(kit, index) {
          kit.Commands.splice(index, 1);
        },
        expandAllKits() {
          Object.keys(this.config.Kits).forEach(kitKey => {
            this.$set(this.expandedKits, kitKey, true);
          });
        },
        collapseAllKits() {
          Object.keys(this.config.Kits).forEach(kitKey => {
            this.$set(this.expandedKits, kitKey, false);
          });
        }
      }
    });

    // --- Shop Items Config Vue Instance ---
    window.shopItemsVue = new Vue({
      el: '#shopitems',
      data: {
        expandedItems: {},
        // Empty shop items by default
        config: {
          ShopItems: {}
        },
        stryderHeadTypes: {
          "-1": "Random",
          "0": "Harvester",
          "1": "Silence Cannon",
          "2": "Machine Gun",
          "3": "Radar"
        },
        stryderChestTypes: {
          "-1": "Random",
          "0": "Shield",
          "1": "One-sided Shield",
          "2": "Cannon",
          "3": "Saddlebags"
        }
      },
      methods: {
        getBlueprintImage,
        toggleItem(key) {
          this.$set(this.expandedItems, key, !this.expandedItems[key]);
        },
        handleTypeChange(key, newType) {
          const item = this.config.ShopItems[key];
          item.Type = newType;

          // Minimal cleanup if type changes
          if (newType === 'dino') {
            delete item.Items;
            if (!item.Blueprint) item.Blueprint = '';
            if (!item.Level) item.Level = 1;
            if (typeof item.PreventCryo === 'undefined') item.PreventCryo = false;
            delete item.Quality;
            delete item.ForceBlueprint;
            delete item.Amount;
            delete item.StryderHead;
            delete item.StryderChest;
          } else if (newType === 'item') {
            // We'll keep or create an Items array
            if (!Array.isArray(item.Items)) {
              const arr = [];
              if (item.Blueprint || item.Amount || item.Quality || item.ForceBlueprint) {
                arr.push({
                  Blueprint: item.Blueprint || '',
                  Amount: item.Amount || 1,
                  Quality: item.Quality || 0,
                  ForceBlueprint: !!item.ForceBlueprint
                });
              }
              item.Items = arr;
            }
            delete item.Blueprint;
            delete item.Amount;
            delete item.Quality;
            delete item.ForceBlueprint;
            delete item.Level;
            delete item.PreventCryo;
            delete item.StryderHead;
            delete item.StryderChest;
          } else {
            // beacon, experience, unlockengram, command => remove item/dino fields
            delete item.Items;
            delete item.Blueprint;
            delete item.Level;
            delete item.PreventCryo;
            delete item.StryderHead;
            delete item.StryderChest;
            delete item.Quality;
            delete item.ForceBlueprint;
            delete item.Amount;
          }
        },
        updateShopItemName(oldName, newName) {
          newName = newName.trim();
          if (!newName || oldName === newName) return;
          if (this.config.ShopItems.hasOwnProperty(newName)) {
            alert("Name already exists. Please choose a unique name.");
            return;
          }
          const itemData = this.config.ShopItems[oldName];
          itemData.name = newName;
          this.$delete(this.config.ShopItems, oldName);
          this.$set(this.config.ShopItems, newName, itemData);
          const expanded = this.expandedItems[oldName];
          this.$delete(this.expandedItems, oldName);
          this.$set(this.expandedItems, newName, expanded);
        },
        addItem() {
          let baseName = "new_item";
          let newName = baseName;
          let counter = 1;
          while (this.config.ShopItems.hasOwnProperty(newName)) {
            newName = baseName + counter;
            counter++;
          }
          const newItem = {
            name: newName,
            Type: "item",
            Description: "",
            Price: 0,
            Permissions: "",
            Items: [
              {
                Blueprint: "",
                Amount: 1,
                Quality: 0,
                ForceBlueprint: false
              }
            ]
          };
          this.$set(this.config.ShopItems, newName, newItem);
          this.$set(this.expandedItems, newName, true);
        },
        removeShopItem(key) {
          if (confirm("Are you sure you want to remove this item?")) {
            this.$delete(this.config.ShopItems, key);
            if (this.expandedItems.hasOwnProperty(key)) {
              this.$delete(this.expandedItems, key);
            }
          }
        },
        addSubItem(shopItemKey) {
          const item = this.config.ShopItems[shopItemKey];
          if (!Array.isArray(item.Items)) {
            this.$set(item, "Items", []);
          }
          item.Items.push({
            Blueprint: "",
            Amount: 1,
            Quality: 0,
            ForceBlueprint: false
          });
        },
        removeSubItem(shopItemKey, idx) {
          const item = this.config.ShopItems[shopItemKey];
          item.Items.splice(idx, 1);
        },
        expandAllItems() {
          Object.keys(this.config.ShopItems).forEach(key => {
            this.$set(this.expandedItems, key, true);
          });
        },
        collapseAllItems() {
          Object.keys(this.config.ShopItems).forEach(key => {
            this.$set(this.expandedItems, key, false);
          });
        }
      }
    });

    // --- Sell Items Config Vue Instance ---
    window.sellItemsVue = new Vue({
      el: '#sellitems',
      data: {
        config: {
          SellItems: {}
        },
        expandedSellItems: {}
      },
      methods: {
        getBlueprintImage,
        toggleSellItem(key) {
          this.$set(this.expandedSellItems, key, !this.expandedSellItems[key]);
        },
        addSellItem() {
          let baseKey = "new_sell_item";
          let key = baseKey;
          let counter = 1;
          while (this.config.SellItems.hasOwnProperty(key)) {
            key = baseKey + counter;
            counter++;
          }
          this.$set(this.config.SellItems, key, {
            Type: "item",
            Description: "",
            Price: 0,
            Amount: 1,
            Blueprint: ""
          });
          this.$set(this.expandedSellItems, key, true);
        },
        removeSellItem(key) {
          if (confirm("Are you sure you want to remove this sell item?")) {
            this.$delete(this.config.SellItems, key);
            this.$delete(this.expandedSellItems, key);
          }
        },
        updateSellItemKey(oldKey, newKey) {
          newKey = newKey.trim();
          if (!newKey || oldKey === newKey) return;
          if (this.config.SellItems.hasOwnProperty(newKey)) {
            alert("ID must be unique");
            return;
          }
          const itemData = this.config.SellItems[oldKey];
          this.$delete(this.config.SellItems, oldKey);
          this.$set(this.config.SellItems, newKey, itemData);
          const expanded = this.expandedSellItems[oldKey];
          this.$delete(this.expandedSellItems, oldKey);
          this.$set(this.expandedSellItems, newKey, expanded);
        },
        expandAllSellItems() {
          Object.keys(this.config.SellItems).forEach(key => {
            this.$set(this.expandedSellItems, key, true);
          });
        },
        collapseAllSellItems() {
          Object.keys(this.config.SellItems).forEach(key => {
            this.$set(this.expandedSellItems, key, false);
          });
        }
      }
    });

    // --- Messages Config Vue Instance ---
    window.messagesVue = new Vue({
      el: '#messages',
      data: {
        config: {
          Messages: {}
        }
      },
      computed: {
        messages() {
          return this.config.Messages;
        }
      },
      methods: {
        updateMessageKey(oldKey, newKey) {
          newKey = newKey.trim();
          if (oldKey === newKey || !newKey) return;
          if (this.messages.hasOwnProperty(newKey)) {
            alert("Key must be unique");
            return;
          }
          const value = this.messages[oldKey];
          this.$delete(this.messages, oldKey);
          this.$set(this.messages, newKey, value);
        },
        removeMessage(key) {
          if (confirm("Are you sure you want to remove this message?")) {
            this.$delete(this.messages, key);
          }
        },
        addMessage() {
          let baseKey = "newMessage";
          let newKey = baseKey;
          let counter = 1;
          while (this.messages.hasOwnProperty(newKey)) {
            newKey = baseKey + counter;
            counter++;
          }
          this.$set(this.messages, newKey, "");
        }
      }
    });

    // --- Complete Config Vue Instance ---
    window.completeConfigVue = new Vue({
      el: '#configApp',
      data: {
        jsonInput: "",
        blueprintStore: window.blueprintStore
      },
      computed: {
        combinedConfig() {
          const gen = window.generalVue.config;
          return {
            Mysql: gen.Mysql,
            General: {
              TimedPointsReward: gen.TimedPointsReward,
              Discord: gen.Discord,
              ItemsPerPage: gen.ItemsPerPage,
              ShopDisplayTime: gen.ShopDisplayTime,
              ShopTextSize: gen.ShopTextSize,
              DbPathOverride: gen.DbPathOverride,
              DefaultKit: gen.DefaultKit,
              GiveDinosInCryopods: gen.GiveDinosInCryopods,
              UseSoulTraps: gen.UseSoulTraps,
              CryoLimitedTime: gen.CryoLimitedTime,
              CryoItemPath: gen.CryoItemPath,
              UseOriginalTradeCommandWithUI: gen.UseOriginalTradeCommandWithUI,
              PreventUseNoglin: gen.PreventUseNoglin,
              PreventUseUnconscious: gen.PreventUseUnconscious,
              PreventUseHandcuffed: gen.PreventUseHandcuffed,
              PreventUseCarried: gen.PreventUseCarried
            },
            Kits: window.kitsVue.config.Kits,
            ShopItems: window.shopItemsVue.config.ShopItems,
            SellItems: window.sellItemsVue.config.SellItems,
            Messages: window.messagesVue.config.Messages
          };
        },
        jsonOutput() {
          return JSON.stringify(this.combinedConfig, null, 2);
        }
      },
      methods: {
        copyJSON() {
          navigator.clipboard.writeText(this.jsonOutput)
            .then(() => alert('JSON copied to clipboard!'))
            .catch(() => alert('Failed to copy JSON.'));
        },
        loadJSON() {
          try {
            const data = JSON.parse(this.jsonInput);
            this.applyJSON(data);
            this.jsonInput = "";
          } catch (err) {
            alert("Error loading JSON configuration: " + err.message);
          }
        },
        loadDemoConfig() {
          fetch('https://miami50x.github.io/arkshop-configurator-ase-asa/ark_shop_demo_1.json')
            .then(response => response.json())
            .then(data => {
              this.applyJSON(data);
            })
            .catch(err => alert("Error fetching demo config: " + err.message));
        },
        applyJSON(data) {
          try {
            // MySQL + General
            if (data.Mysql) {
              window.generalVue.config.Mysql = data.Mysql;
            }
            if (data.General) {
              Object.assign(window.generalVue.config, data.General);
            }

            // Kits
            if (data.Kits) {
              Object.entries(data.Kits).forEach(([kitKey, kitObj]) => {
                // Migrate older single fields to Items array if needed
                if (!Array.isArray(kitObj.Items) && (kitObj.Blueprint || kitObj.Amount || kitObj.Quality || kitObj.ForceBlueprint)) {
                  const arr = [{
                    Blueprint: kitObj.Blueprint || '',
                    Amount: kitObj.Amount || 1,
                    Quality: kitObj.Quality || 0,
                    ForceBlueprint: !!kitObj.ForceBlueprint
                  }];
                  kitObj.Items = arr;
                  delete kitObj.Blueprint;
                  delete kitObj.Amount;
                  delete kitObj.Quality;
                  delete kitObj.ForceBlueprint;
                }
                if (!Array.isArray(kitObj.Items)) kitObj.Items = [];
                if (!Array.isArray(kitObj.Dinos)) kitObj.Dinos = [];
                if (!Array.isArray(kitObj.Commands)) kitObj.Commands = [];
              });
              window.kitsVue.config.Kits = data.Kits;
              window.kitsVue.expandedKits = {};
            }

            // ShopItems
            if (data.ShopItems) {
              Object.entries(data.ShopItems).forEach(([key, item]) => {
                if (item.Type === 'item') {
                  if (!Array.isArray(item.Items)) {
                    const arr = [];
                    if (item.Blueprint || item.Amount || item.Quality || item.ForceBlueprint) {
                      arr.push({
                        Blueprint: item.Blueprint || '',
                        Amount: item.Amount || 1,
                        Quality: item.Quality || 0,
                        ForceBlueprint: !!item.ForceBlueprint
                      });
                    }
                    item.Items = arr;
                  }
                  delete item.Blueprint;
                  delete item.Amount;
                  delete item.Quality;
                  delete item.ForceBlueprint;
                  delete item.Level;
                  delete item.PreventCryo;
                  delete item.StryderHead;
                  delete item.StryderChest;
                }
              });
              window.shopItemsVue.config.ShopItems = data.ShopItems;
              window.shopItemsVue.expandedItems = {};
            }

            // SellItems
            if (data.SellItems) {
              window.sellItemsVue.config.SellItems = data.SellItems;
              window.sellItemsVue.expandedSellItems = {};
            }

            // Messages
            if (data.Messages) {
              window.messagesVue.config.Messages = data.Messages;
            }

            alert("Configuration loaded successfully!");
          } catch (err) {
            alert("Error applying JSON configuration: " + err.message);
          }
        }
      }
    });
  </script>
</body>
</html>
